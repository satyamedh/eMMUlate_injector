document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("appMode"),t=document.getElementById("tutorialMode"),n=document.getElementById("tutorialContent");t.classList.remove("hidden"),"undefined"!=typeof marked?n.innerHTML=marked.parse("\n# Welcome to eMMUlator injector!\nThis tool allows you to inject 3DES decryption keys into .tns files for use with firebird.\n\n## CX II firebird emulation:\n1. After getting your injected_btrom.tns, create a new CX II kit in firebird.\n2. Set boot1 to your injected_btrom.tns file, and create a new flash with the other files you got from polydumper.\n3. Finally, start that kit. It will ask you to install the OS, and you should be able to drop the OS installation file used by your specific calculator model(.tcc2, .tco2, .tct2, etc).\n4. The installation will proceed and there will be a blank screen at times. After waiting for a while, click the reset button on the top left in case of a blank screen. After a couple resets, the installation should complete and you will have a working emulated CX II calculator with the OS installed!\n\n## Instructions on how to use eMMUlator can be found on the Github page [here](https://github.com/satyamedh/eMMUlator)\n\n\n\n  "):n.innerHTML='<p class="text-red-500">Error: Marked library not loaded.</p>';const o=document.getElementById("urlParamsContainer"),l=window.location.search,s=new URLSearchParams(l);if(Array.from(s).length>0){e.classList.remove("hidden"),o.innerHTML="";const t=document.createElement("ul");t.classList.add("list-disc","list-inside");const n={};console.log("--- Decryption Keys ---");for(let e=1;e<=4;e++){n[`set${e}`]=[];for(let o=1;o<=3;o++){const l=s.get(`l${e}${o}`),i=s.get(`r${e}${o}`);if(l&&i){const s=l+i;n[`set${e}`].push(s),console.log(`Set ${e}, Key ${o}: ${s}`);const a=document.createElement("li"),d=document.createElement("span");d.className="font-semibold text-blue-400",d.textContent=`Set ${e} Key ${o}`,a.appendChild(d),a.appendChild(document.createTextNode(`: ${s}`)),t.appendChild(a)}}}console.log("All Keys:",n),o.appendChild(t);const l=document.getElementById("fileInput"),i=document.getElementById("fileNameDisplay"),a=document.getElementById("injectBtn");let d=null;l.addEventListener("change",e=>{const t=e.target.files[0];if(t){const e=t.name,n=e.split(".").pop().toLowerCase();"bin"===n||"tns"===n?(d=t,i.textContent=`Selected file: ${e}`,i.classList.remove("hidden"),i.classList.remove("text-red-500"),i.classList.add("text-green-400"),a.classList.remove("hidden"),console.log("File selected:",t)):(d=null,i.textContent="Invalid file type. Please select a .bin or .tns file.",i.classList.remove("hidden"),i.classList.remove("text-green-400"),i.classList.add("text-red-500"),l.value="",a.classList.add("hidden"))}else d=null,i.classList.add("hidden"),a.classList.add("hidden")}),a.addEventListener("click",()=>{if(!d)return;const e=new FileReader;e.onload=function(e){const t=e.target.result,n=new DataView(t),o={1:39,2:61,3:37,4:45};try{for(let e=1;e<=4;e++){const t=o[e];let l,i=t;if(t<117){t<32?l=155648:(l=161792,i=t-32);const o=l+24*i;console.log(`Injecting Set ${e} (Index 0x${t.toString(16)}) at Offset 0x${o.toString(16)}`);for(let t=1;t<=3;t++){const l=s.get(`l${e}${t}`),i=s.get(`r${e}${t}`);if(l&&i){const e=parseInt(l,16),s=parseInt(i,16),a=o+8*(t-1);n.setUint32(a,s,!0),n.setUint32(a+4,e,!0),console.log(`  Key ${t}: L=0x${e.toString(16)} R=0x${s.toString(16)}`)}else console.warn(`  Missing key parts for Set ${e} Key ${t}`)}}}const e=new Blob([t],{type:"application/octet-stream"}),l=window.URL.createObjectURL(e),i=document.createElement("a");i.href=l,i.download=`injected_${d.name}`,document.body.appendChild(i),i.click(),window.URL.revokeObjectURL(l),document.body.removeChild(i),alert("Injection successful! File downloaded.")}catch(e){console.error("Injection failed:",e),alert("Injection failed. See console for details.")}},e.readAsArrayBuffer(d)})}else e.classList.add("hidden")});